{% extends 'base.html' %}

{% block container %}

    <form method="post">
        <h2 class="subtitle">
            Create
        </h2>
        <p class="help has-text-left">Write your secret</p>
        <div class="field">
            <p class="control">
            <textarea class="textarea" name="inputSecret" id="inputSecret" rows="5" placeholder="(Tip: for added security, avoid telling what is the use of the secret you're sharing. Explain it in your email, along the link generated by Shhh.)" autocomplete="off" required></textarea>
            </p>
        </div>
        <p class="help has-text-left">Auto-destroy in</p>
        <div class="field">
            <div class="control ">
                <div class="select">
                    <select id="expiresValue" name="expiresValue">
                        <option value="1">1 day</option>
                        <option value="2">2 days</option>
                        <option value="3">3 days</option>
                        <option value="7">1 week</option>
                    </select>
                </div>
            </div>
        </div>
        <p class="help has-text-left">Passphrase to open secret</p>
        <div class="field is-grouped">
            <p class="control is-expanded">
            <input class="input" id="passPhrase" name="passPhrase" type="text" placeholder="Passphrase" autocomplete="off" required>
            <p class="control">
            <button type="button" class="button is-primary" id="createBtn">Go</button>
            </p>
        </div>
    </form>

    <br />
    <div id="response"><p id="msg"></p></div>
{% endblock %}

{% block js %}

    <script>
        document.getElementById('createBtn').addEventListener('click', _ => {
            const inputSecret = document.getElementById('inputSecret').value;
            const passPhrase = document.getElementById('passPhrase').value;
            const expiresValue = document.getElementById('expiresValue').value;
            fetch('/api/c', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    secret: inputSecret,
                    passphrase: passPhrase,
                    days: parseInt(expiresValue)
                }),
                cache: 'no-store'
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                switch (data.status) {
                    case 'created':
                        window.location.href = `/c?link=${data.link}&expires_on=${data.expires_on}`;
                        break;
                    case 'error':
                        document.getElementById('response').className = 'p-top alert-error';
                        document.getElementById('msg').setAttribute('style', 'white-space: pre;');
                        document.getElementById('msg').textContent = data.details;
                        break;
                }
            });
        });
    </script>

{% endblock %}
